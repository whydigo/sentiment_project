<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ Excel –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .upload-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        
        .upload-area:hover {
            background: #e8f0fe;
            border-color: #764ba2;
        }
        
        .upload-area i {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-info {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            border-left: 4px solid #4CAF50;
        }
        
        .column-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            display: none;
        }
        
        .preview-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .preview-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .preview-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .preview-table tr:hover {
            background: #f0f0f0;
        }
        
        .progress-container {
            margin: 30px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9em;
        }
        
        .job-status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .status-processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .download-btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            margin: 20px 0;
            transition: transform 0.3s;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .rows-selector {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .rows-selector h4 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rows-selector select, .rows-selector input {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .rows-selector select:hover, .rows-selector input:hover {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102,126,234,0.2);
        }
        
        #customRowInput {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            justify-content: center;
            margin-top: 20px;
        }
        
        .stop-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stop-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .stop-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .cancelled-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #ffc107;
        }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            border: 2px solid #667eea;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .nav-btn.active {
            background: #667eea;
            color: white;
        }
        
        .model-info {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .info-message {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
            font-size: 0.9rem;
        }
        
        .info-message i {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-file-excel"></i> –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ Excel</h1>
            <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p>
            
            <div class="navigation">
                <a href="/" class="nav-btn">
                    <i class="fas fa-home"></i> –û–¥–∏–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
                </a>
                <a href="/upload" class="nav-btn active">
                    <i class="fas fa-file-excel"></i> –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
                </a>
            </div>
            
            <div class="model-info">
                <i class="fas fa-info-circle"></i>
                –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç—ã –∏ –¥–æ–±–∞–≤–∏—Ç –∫–æ–ª–æ–Ω–∫–∏ —Å —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –∏ —Ç–µ–º–∞—Ç–∏–∫–æ–π
            </div>
        </header>

        <div class="main-content">
            <div class="upload-container">
                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excel —Ñ–∞–π–ª–∞</h3>
                    <p>–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                    <p style="font-size: 0.9em; color: #999;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: .xlsx, .xls, .csv</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ -->
                <div class="file-info" id="fileInfo">
                    <h4><i class="fas fa-check-circle" style="color: #4CAF50;"></i> –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω:</h4>
                    <p id="fileName"></p>
                    <p id="fileDetails"></p>
                </div>

                <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª–æ–Ω–∫–∏ -->
                <div class="column-selector" id="columnSelector">
                    <h4><i class="fas fa-columns"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É —Å —Ç–µ–∫—Å—Ç–∞–º–∏:</h4>
                    <select id="columnSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #667eea; border-radius: 5px;">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–æ–Ω–æ–∫...</option>
                    </select>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, —á—Ç–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ -->
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i>
                        –ë—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏: <strong>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</strong> –∏ <strong>–¢–µ–º–∞—Ç–∏–∫–∞</strong>
                    </div>

                    <!-- –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫ -->
                    <div class="rows-selector">
                        <h4><i class="fas fa-list-ol"></i> –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫:</h4>
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1;">
                                <label for="rowCount" style="display: block; margin-bottom: 5px; color: #333;">
                                    <i class="fas fa-calculator"></i> –°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å:
                                </label>
                                <select id="rowCount" style="width: 100%; padding: 10px;">
                                    <option value="0">üìä –í—Å–µ —Å—Ç—Ä–æ–∫–∏ (–ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑)</option>
                                    <option value="10">üîü –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫</option>
                                    <option value="50">üî¢ –ü–µ—Ä–≤—ã–µ 50 —Å—Ç—Ä–æ–∫</option>
                                    <option value="100" selected>üíØ –ü–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫</option>
                                    <option value="500">üî• –ü–µ—Ä–≤—ã–µ 500 —Å—Ç—Ä–æ–∫</option>
                                    <option value="1000">‚ö° –ü–µ—Ä–≤—ã–µ 1000 —Å—Ç—Ä–æ–∫</option>
                                    <option value="custom">‚úèÔ∏è –°–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                                </select>
                            </div>
                            <div id="customRowInput" style="display: none; flex: 1;">
                                <label style="display: block; margin-bottom: 5px; color: #333;">
                                    <i class="fas fa-pencil-alt"></i> –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:
                                </label>
                                <input type="number" id="customRowCount" min="1" max="10000" value="100">
                            </div>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            <i class="fas fa-info-circle"></i> 
                            <span id="totalRowsInfo">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</span>
                        </p>
                    </div>
                    
                    <button class="btn analyze-btn" onclick="startAnalysis()">
                        <i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑
                    </button>
                </div>

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
                <div class="progress-container" id="progressContainer">
                    <h4><i class="fas fa-chart-line"></i> –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞:</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                    </div>
                    <p id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</p>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ -->
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="stopAnalysis()" class="btn stop-btn" id="stopButton" style="display: none;">
                            <i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                        </button>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏—è -->
                <div class="job-status" id="jobStatus"></div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
                <div id="resultContainer" style="text-align: center; display: none;">
                    <a href="#" id="downloadLink" class="download-btn">
                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    </a>
                    <p style="margin-top: 10px; color: #666;">
                        <i class="fas fa-clock"></i> –§–∞–π–ª –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞
                    </p>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                <div id="previewContainer" style="display: none;">
                    <h4><i class="fas fa-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):</h4>
                    <div class="preview-table" id="previewTable"></div>
                </div>
            </div>
        </div>

        <footer>
            <p>–ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤ ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: .xlsx, .xls, .csv</p>
        </footer>
    </div>

    <script>
        let currentJobId = null;
        let checkInterval = null;
        let totalRows = 0;
        let isCancelled = false;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            console.log('üìÅ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª —á–µ—Ä–µ–∑ input');
            uploadFile(this.files[0]);
        });

        document.getElementById('rowCount').addEventListener('change', function() {
            const customInput = document.getElementById('customRowInput');
            if (this.value === 'custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
        });

        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#e8f0fe';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#f8f9fa';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#f8f9fa';
            const file = e.dataTransfer.files[0];
            if (file) {
                console.log('üìÅ –§–∞–π–ª –ø–µ—Ä–µ—Ç–∞—â–µ–Ω:', file.name);
                uploadFile(file);
            }
        });

        function uploadFile(file) {
            if (!file) {
                console.error('‚ùå –ù–µ—Ç —Ñ–∞–π–ª–∞');
                return;
            }

            console.log('üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª:', file.name, '—Ä–∞–∑–º–µ—Ä:', file.size);

            const formData = new FormData();
            formData.append('file', file);

            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileDetails').textContent = `–†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(2)} KB | –¢–∏–ø: ${file.type || 'Excel'}`;

            const uploadArea = document.getElementById('uploadArea');
            uploadArea.style.opacity = '0.5';
            uploadArea.style.pointerEvents = 'none';

            console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
            
            fetch('/upload_excel', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, —Å—Ç–∞—Ç—É—Å:', response.status);
                const data = await response.json();
                console.log('üì¶ –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                return data;
            })
            .then(data => {
                console.log('‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:', data);
                if (data.error) {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                    uploadArea.style.opacity = '1';
                    uploadArea.style.pointerEvents = 'auto';
                } else {
                    showColumnSelector(data);
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                uploadArea.style.opacity = '1';
                uploadArea.style.pointerEvents = 'auto';
            });
        }

        function showColumnSelector(data) {
            console.log('üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª–æ–Ω–æ–∫');
            
            totalRows = data.total_rows || 0;
            document.getElementById('totalRowsInfo').textContent = `–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: ${totalRows}`;
            
            const selector = document.getElementById('columnSelector');
            const select = document.getElementById('columnSelect');
            
            select.innerHTML = '';
            
            data.columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.letter;
                option.textContent = col.display;
                
                if (col.letter === 'D') {
                    option.selected = true;
                    console.log('‚úÖ –ö–æ–ª–æ–Ω–∫–∞ D –≤—ã–±—Ä–∞–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                }
                
                select.appendChild(option);
            });

            selector.style.display = 'block';

            const previewContainer = document.getElementById('previewContainer');
            const previewTable = document.getElementById('previewTable');
            
            let html = '<table><tr>';
            data.preview.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr>';
            
            data.preview.rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${cell || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            
            previewTable.innerHTML = html;
            previewContainer.style.display = 'block';
            
            document.getElementById('uploadArea').style.opacity = '1';
            document.getElementById('uploadArea').style.pointerEvents = 'auto';
            
            console.log('‚úÖ –°–µ–ª–µ–∫—Ç–æ—Ä –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
        }

        function startAnalysis() {
            const columnLetter = document.getElementById('columnSelect').value;
            
            let rowLimit = document.getElementById('rowCount').value;
            if (rowLimit === 'custom') {
                rowLimit = parseInt(document.getElementById('customRowCount').value) || 0;
            } else {
                rowLimit = parseInt(rowLimit);
            }

            console.log('‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞:', {
                column: columnLetter,
                rowLimit: rowLimit,
                totalRows: totalRows
            });

            if (!columnLetter) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É —Å —Ç–µ–∫—Å—Ç–∞–º–∏');
                return;
            }

            if (rowLimit > 0 && totalRows > 0 && rowLimit > totalRows) {
                if (!confirm(`–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å ${rowLimit} —Å—Ç—Ä–æ–∫, –Ω–æ –≤ —Ñ–∞–π–ª–µ –≤—Å–µ–≥–æ ${totalRows} —Å—Ç—Ä–æ–∫. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ ${totalRows} —Å—Ç—Ä–æ–∫?`)) {
                    return;
                }
                rowLimit = totalRows;
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Ç–º–µ–Ω—ã
            isCancelled = false;
            
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('columnSelector').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            document.getElementById('stopButton').style.display = 'inline-block';
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ –µ—Å–ª–∏ –±—ã–ª–æ
            const oldCancelMsg = document.getElementById('cancelledMessage');
            if (oldCancelMsg) oldCancelMsg.remove();

            fetch('/start_batch_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    column: columnLetter,
                    row_limit: rowLimit
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('üì• –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.error) {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                } else {
                    currentJobId = data.job_id;
                    startProgressCheck();
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message);
                document.getElementById('stopButton').style.display = 'none';
            });
        }

        function stopAnalysis() {
            if (!currentJobId) return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑? –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
                console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', currentJobId);
                
                isCancelled = true;
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                const stopBtn = document.getElementById('stopButton');
                stopBtn.disabled = true;
                stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...';
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É
                fetch(`/stop_analysis/${currentJobId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ –ê–Ω–∞–ª–∏–∑ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', data);
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                    showCancelledMessage();
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    stopBtn.style.display = 'none';
                    document.getElementById('progressFill').style.width = '0%';
                    document.getElementById('progressFill').textContent = '0%';
                    document.getElementById('progressText').textContent = '–ê–Ω–∞–ª–∏–∑ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª–æ–Ω–∫–∏
                    setTimeout(() => {
                        document.getElementById('columnSelector').style.display = 'block';
                        document.getElementById('progressContainer').style.display = 'none';
                    }, 2000);
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∞–Ω–∞–ª–∏–∑–∞');
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
                });
            }
        }

        function showCancelledMessage() {
            const container = document.querySelector('.upload-container');
            const messageDiv = document.createElement('div');
            messageDiv.id = 'cancelledMessage';
            messageDiv.className = 'cancelled-message';
            messageDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                –ê–Ω–∞–ª–∏–∑ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            `;
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const progressContainer = document.getElementById('progressContainer');
            container.insertBefore(messageDiv, progressContainer.nextSibling);
        }

        function startProgressCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            checkInterval = setInterval(checkProgress, 1000);
        }

        function checkProgress() {
            if (!currentJobId) return;
            if (isCancelled) return;

            fetch(`/job_status/${currentJobId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);
                    
                    if (data.status === 'completed') {
                        clearInterval(checkInterval);
                        showDownloadLink(data.result_filename);
                    } else if (data.status === 'error') {
                        clearInterval(checkInterval);
                        showError(data.error);
                    } else if (data.status === 'cancelled') {
                        clearInterval(checkInterval);
                        showCancelledMessage();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateProgress(data) {
            if (isCancelled) return;
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const percent = Math.round((data.progress / data.total) * 100) || 0;
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            
            progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.progress} –∏–∑ ${data.total} —Ç–µ–∫—Å—Ç–æ–≤`;
            
            const jobStatus = document.getElementById('jobStatus');
            jobStatus.style.display = 'block';
            jobStatus.className = 'job-status status-processing';
            jobStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> –ê–Ω–∞–ª–∏–∑ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...`;
        }

        function showDownloadLink(filename) {
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            document.getElementById('stopButton').style.display = 'none';
            
            const jobStatus = document.getElementById('jobStatus');
            jobStatus.className = 'job-status status-completed';
            jobStatus.innerHTML = `<i class="fas fa-check-circle"></i> –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!`;
            
            document.getElementById('resultContainer').style.display = 'block';
            document.getElementById('downloadLink').href = `/download/${filename}`;
        }

        function showError(error) {
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            document.getElementById('stopButton').style.display = 'none';
            
            const jobStatus = document.getElementById('jobStatus');
            jobStatus.style.display = 'block';
            jobStatus.className = 'job-status status-error';
            jobStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> –û—à–∏–±–∫–∞: ${error}`;
        }
    </script>
</body>
</html>